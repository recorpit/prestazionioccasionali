<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Ricevute per Prestazioni Artistiche</title>
    
    <!-- Librerie External -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container no-print">
        <h1>Generatore Ricevute per Prestazioni Artistiche</h1>
        <p>Sistema automatizzato per generare ricevute processando SOLO movimenti di persone presenti nelle iscrizioni</p>
        
        <!-- Step 1: Carica file iscrizioni -->
        <div class="step" id="step1">
            <h2>Step 1: Carica File Iscrizioni</h2>
            <div class="info-box">
                <strong>Formato richiesto:</strong> File Excel (.xlsx) con foglio "ISCRIZIONI"<br>
                <strong>Struttura:</strong> Colonna B=CF, C=Cognome, D=Nome, H=Indirizzo, I=Citt√†, J=Provincia, K=CAP, M=P.IVA<br>
                <em>Solo i movimenti di persone presenti in questo file verranno processati</em>
            </div>
            <input type="file" id="iscrizioniFile" accept=".xlsx,.xls">
            <button onclick="loadIscrizioni()">Carica Iscrizioni</button>
            <div id="iscrizioniResult"></div>
        </div>
        
        <!-- Step 2: Carica movimenti bancari -->
        <div class="step inactive" id="step2">
            <h2>Step 2: Carica Movimenti Bancari</h2>
            <div class="info-box">
                <strong>Logica di processing:</strong><br>
                ‚Ä¢ <strong>ADDEBITI</strong> (Colonna G): Pagamenti verso artisti ‚Üí Genereranno ricevute<br>
                ‚Ä¢ <strong>ACCREDITI</strong> (Colonna F): Bonifici ricevuti ‚Üí Controllo per possibili rimborsi<br>
                ‚Ä¢ <strong>Colonna CONTROPARTE</strong> (C): Usata per matching con nomi iscrizioni<br><br>
                <strong>Scala rimborsi:</strong> 20‚Ç¨ sotto 51‚Ç¨, 30‚Ç¨ tra 51-80‚Ç¨, 40‚Ç¨ tra 80-150‚Ç¨, 60‚Ç¨ tra 150-250‚Ç¨, 100‚Ç¨ tra 250-350‚Ç¨, 150‚Ç¨ tra 350-450‚Ç¨, 200‚Ç¨ tra 450-500‚Ç¨, 40% sopra 500‚Ç¨
            </div>
            <input type="file" id="movimentiFile" accept=".xlsx,.xls" disabled>
            <button onclick="loadMovimenti()" disabled id="loadMovimentiBtn">Carica Movimenti</button>
            <div id="movimentiResult"></div>
        </div>
        
        <!-- Step 3: Matching e generazione -->
        <div class="step inactive" id="step3">
            <h2>Step 3: Matching Intelligente e Generazione</h2>
            <div class="info-box">
                <strong>Il sistema processer√†:</strong><br>
                ‚úÖ ADDEBITI verso persone nelle iscrizioni ‚Üí Ricevute automatiche<br>
                ‚ö†Ô∏è ACCREDITI da persone nelle iscrizioni ‚Üí Controllo manuale (possibili rimborsi)<br>
                üìÅ ADDEBITI verso persone NON nelle iscrizioni ‚Üí Archivio per gestione manuale<br>
                üö´ ACCREDITI da persone NON nelle iscrizioni ‚Üí Completamente ignorati
            </div>
            
            <button onclick="performMatching()" disabled id="matchBtn" style="background: #007bff; font-size: 16px; padding: 12px 24px;">
                üîç Esegui Matching Intelligente
            </button>
            
            <button onclick="generateReceipts()" disabled id="generateBtn" style="background: #28a745; font-size: 16px; padding: 12px 24px;">
                üìÑ Genera Ricevute HTML
            </button>
            
            <!-- Controlli Export -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-top: 0; color: #495057;">üéØ Opzioni Export</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button onclick="generatePDFPreviews()" id="pdfPreviewBtn" disabled
                            style="background: #6f42c1; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üëÅÔ∏è Anteprima PDF
                    </button>
                    
                    <button onclick="createZipWithPDFs()" id="downloadBtn" disabled
                            style="background: #dc3545; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üì¶ ZIP PDF (Tutti)
                    </button>
                    
                    <button onclick="createZipWithPDFsByMonth()" id="downloadByMonthBtn" disabled
                            style="background: #fd7e14; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üìÖ ZIP PDF per Mese
                    </button>
                    
                    <button onclick="exportToExcel()" id="exportBtn" disabled
                            style="background: #20c997; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üìä Export Excel
                    </button>
                    
                    <button onclick="exportToExcelByMonth()" id="exportByMonthBtn" disabled
                            style="background: #17a2b8; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üóìÔ∏è Excel per Mese
                    </button>
                    
                    <button onclick="resetAllCounters()" 
                            style="background: #6c757d; color: white; padding: 10px; border: none; border-radius: 5px;">
                        üîÑ Reset Numerazione
                    </button>
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="downloadArea"></div>
            
            <!-- Tab Navigation -->
            <div class="tabs" style="margin-top: 30px;">
                <button class="tab active" onclick="showTab('matching')">üéØ Risultati Matching</button>
                <button class="tab" onclick="showTab('preview')">üìã Anteprima Ricevute</button>
                <button class="tab" onclick="showTab('pdfpreview')">üñºÔ∏è Anteprima PDF</button>
            </div>
            
            <div id="matchingTab" class="tab-content active">
                <div id="matchingResult">
                    <p style="text-align: center; color: #6c757d; padding: 40px; font-style: italic;">
                        Carica i file Excel e clicca su "Esegui Matching Intelligente" per vedere i risultati dell'analisi automatica.
                    </p>
                </div>
            </div>
            
            <div id="previewTab" class="tab-content">
                <div id="previewArea">
                    <p style="text-align: center; color: #6c757d; padding: 40px; font-style: italic;">
                        Dopo il matching, clicca su "Genera Ricevute HTML" per vedere l'anteprima delle ricevute che verranno create.
                    </p>
                </div>
            </div>
            
            <div id="pdfpreviewTab" class="tab-content">
                <div id="pdfPreviewArea">
                    <p style="text-align: center; color: #6c757d; padding: 40px; font-style: italic;">
                        Dopo aver generato le ricevute HTML, clicca su "Anteprima PDF" per vedere come appariranno i documenti finali.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Info Box aggiuntive -->
        <div style="margin-top: 30px; background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 5px solid #2196f3;">
            <h3 style="color: #1976d2; margin-top: 0;">üí° Come Funziona il Sistema</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div>
                    <strong>1Ô∏è‚É£ Matching Automatico</strong><br>
                    <small>Il sistema matcha automaticamente le controparti dei movimenti bancari con i nomi nel file iscrizioni</small>
                </div>
                <div>
                    <strong>2Ô∏è‚É£ Separazione Intelligente</strong><br>
                    <small>Divide addebiti (ricevute) da accrediti (possibili rimborsi) per controllo preciso</small>
                </div>
                <div>
                    <strong>3Ô∏è‚É£ Archivio Non Matchati</strong><br>
                    <small>Conserva movimenti di persone non nelle iscrizioni per gestione manuale</small>
                </div>
                <div>
                    <strong>4Ô∏è‚É£ Controllo Duplicati</strong><br>
                    <small>Evidenzia possibili bonifici errati quando ci sono sia addebiti che accrediti per la stessa persona</small>
                </div>
            </div>
        </div>
    </div>
    
    <div id="receiptsContainer"></div>
    
    <!-- Scripts - Carica utils.js per primo per evitare problemi di dipendenze -->
    <script src="utils.js"></script>
    <script>
        // Attende che utils.js sia completamente caricato prima di procedere
        function waitForUtils() {
            return new Promise((resolve) => {
                if (typeof normalizeString === 'function' && 
                    typeof getCurrentReceiptNumber === 'function' && 
                    typeof updateProgressBar === 'function') {
                    resolve();
                } else {
                    setTimeout(() => waitForUtils().then(resolve), 50);
                }
            });
        }
        
        // Carica gli altri script dopo utils.js
        waitForUtils().then(() => {
            const scripts = [
                'matching.js',
                'receipts.js', 
                'pdf-export.js',
                'excel-export.js'
            ];
            
            let loadedScripts = 0;
            
            scripts.forEach((scriptSrc, index) => {
                const script = document.createElement('script');
                script.src = scriptSrc;
                script.async = false; // Mantiene l'ordine di esecuzione
                script.onload = () => {
                    loadedScripts++;
                    console.log(`Caricato: ${scriptSrc}`);
                    
                    // Quando tutti i script sono caricati
                    if (loadedScripts === scripts.length) {
                        console.log('Tutti i moduli JavaScript sono stati caricati');
                        checkAllFunctions();
                    }
                };
                script.onerror = () => {
                    console.error(`Errore nel caricamento di: ${scriptSrc}`);
                };
                document.head.appendChild(script);
            });
        });
        
        function checkAllFunctions() {
            const functions = [
                'performMatching',
                'generateReceipts', 
                'generatePDFPreviews',
                'createZipWithPDFs',
                'createZipWithPDFsByMonth',
                'exportToExcel',
                'exportToExcelByMonth',
                'resetAllCounters'
            ];
            
            const missing = functions.filter(func => typeof window[func] !== 'function');
            
            if (missing.length > 0) {
                console.error('Funzioni mancanti:', missing);
            } else {
                console.log('‚úÖ Tutte le funzioni sono disponibili');
            }
        }
    </script>
    
    <script>
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema caricato, verifico librerie...');
            setTimeout(() => {
                if (typeof checkLibrariesLoaded === 'function') {
                    if (checkLibrariesLoaded()) {
                        console.log('‚úÖ Tutte le librerie sono caricate correttamente');
                    }
                } else {
                    console.log('‚è≥ Funzione checkLibrariesLoaded in caricamento...');
                }
            }, 100);
        });
    </script>
</body>
</html>
