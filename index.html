<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Ricevute per Prestazioni Artistiche</title>
    
    <!-- Librerie External -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container no-print">
        <h1>Generatore Ricevute per Prestazioni Artistiche</h1>
        <p>Sistema automatizzato per generare ricevute incrociando dati anagrafici e movimenti bancari</p>
        
        <!-- Step 1: Carica file iscrizioni -->
        <div class="step" id="step1">
            <h2>Step 1: Carica File Iscrizioni</h2>
            <div class="info-box">
                <strong>Formato richiesto:</strong> File Excel (.xlsx) con foglio "ISCRIZIONI"<br>
                Colonna B: Codice Fiscale | Colonna C: Cognome | Colonna D: Nome<br>
                Colonna H: Indirizzo | Colonna I: Città | Colonna J: Provincia | Colonna K: CAP | Colonna M: P.IVA
            </div>
            <input type="file" id="iscrizioniFile" accept=".xlsx,.xls">
            <button onclick="loadIscrizioni()">Carica Iscrizioni</button>
            <div id="iscrizioniResult"></div>
        </div>
        
        <!-- Step 2: Carica movimenti bancari -->
        <div class="step inactive" id="step2">
            <h2>Step 2: Carica Movimenti Bancari</h2>
            <div class="info-box">
                <strong>Colonne richieste:</strong> "controparte" per il nome, "ADDEBITI" per gli importi<br>
                <strong>Nuova scala rimborsi:</strong> ≥80€→40€, ≥150€→60€, ≥250€→100€, ≥350€→150€, ≥450€→200€, ≥500€→40% dell'importo
            </div>
            <input type="file" id="movimentiFile" accept=".xlsx,.xls" disabled>
            <button onclick="loadMovimenti()" disabled id="loadMovimentiBtn">Carica Movimenti</button>
            <div id="movimentiResult"></div>
        </div>
        
        <!-- Step 3: Matching e generazione -->
        <div class="step inactive" id="step3">
            <h2>Step 3: Matching e Generazione Ricevute</h2>
            <button onclick="performMatching()" disabled id="matchBtn">Esegui Matching</button>
            <button onclick="generateReceipts()" disabled id="generateBtn">Genera Ricevute</button>
            
            <div style="margin-top: 10px;">
                <button onclick="generatePDFPreviews()" id="pdfPreviewBtn" class="btn-purple" disabled>
                    Anteprima PDF
                </button>
                
                <button onclick="createZipWithPDFs()" id="downloadBtn" class="btn-success" disabled>
                    Crea ZIP con PDF
                </button>
                
                <button onclick="exportToExcel()" id="exportBtn" class="btn-info" disabled>
                    Esporta Excel
                </button>
                
                <button onclick="exportToExcelByMonth()" id="exportByMonthBtn" class="btn-info" disabled>
                    Esporta Excel per Mese
                </button>
                
                <button onclick="resetAllCounters()" class="btn-warning">
                    Reset Numerazione
                </button>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="downloadArea"></div>
            
            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="showTab('matching')">Risultati Matching</button>
                <button class="tab" onclick="showTab('preview')">Anteprima Ricevute</button>
                <button class="tab" onclick="showTab('pdfpreview')">Anteprima PDF</button>
            </div>
            
            <div id="matchingTab" class="tab-content active">
                <div id="matchingResult"></div>
            </div>
            
            <div id="previewTab" class="tab-content">
                <div id="previewArea"></div>
            </div>
            
            <div id="pdfpreviewTab" class="tab-content">
                <div id="pdfPreviewArea">
                    <p style="text-align: center; color: #666; padding: 20px;">
                        Genera prima le ricevute, poi clicca su "Anteprima PDF" per vedere come appariranno i PDF.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="receiptsContainer"></div>
    
    <!-- Scripts -->
    <script src="utils.js"></script>
    <script src="matching.js"></script>
    <script src="receipts.js"></script>
    <script src="pdf-export.js"></script>
    <script src="excel-export.js"></script>
    
    <script>
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema caricato, verifico librerie...');
            if (checkLibrariesLoaded()) {
                console.log('Tutte le librerie sono state caricate correttamente');
            }
        });
    </script>
</body>
</html>
