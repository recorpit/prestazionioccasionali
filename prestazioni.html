<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Ricevute per Prestazioni Artistiche</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #333;
        }
        
        .step {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .step.inactive {
            border-left-color: #ccc;
            opacity: 0.6;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="file"] {
            display: block;
            margin: 10px 0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
        }
        
        .success-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
        }
        
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .match-status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .match-found {
            background-color: #4CAF50;
            color: white;
        }
        
        .match-not-found {
            background-color: #f44336;
            color: white;
        }
        
        /* Stili per la ricevuta */
        .ricevuta {
            background-color: white;
            padding: 40px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            page-break-after: always;
            min-height: 297mm;
            width: 210mm;
            margin: 0 auto 20px;
            box-sizing: border-box;
        }
        
        .ricevuta-header {
            margin-bottom: 30px;
        }
        
        .ricevuta-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .ricevuta-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .ricevuta-table th {
            background-color: #003d7a;
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .ricevuta-table td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .ricevuta-table .amount {
            text-align: right;
        }
        
        .ricevuta-footer {
            margin-top: 30px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .signature-line {
            margin-top: 50px;
            text-align: right;
        }
        
        .signature {
            font-family: "Brush Script MT", cursive;
            color: #003d7a;
            font-size: 18px;
            font-style: italic;
        }
        
        .no-print {
            display: block;
        }
        
        @media print {
            body {
                margin: 0;
                background-color: white;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
            }
            
            .no-print {
                display: none !important;
            }
            
            .ricevuta {
                border: none;
                margin: 0;
                padding: 20mm;
            }
        }
        
        #previewArea {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab.active {
            border-bottom: 2px solid #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container no-print">
        <h1>Generatore Ricevute per Prestazioni Artistiche</h1>
        <p>Sistema automatizzato per generare ricevute incrociando dati anagrafici e movimenti bancari</p>
        
        <!-- Step 1: Carica file iscrizioni -->
        <div class="step" id="step1">
            <h2>Step 1: Carica File Iscrizioni</h2>
            <div class="info-box">
                <strong>Formato richiesto:</strong> File Excel (.xlsx) con struttura:<br>
                Colonna A: Codice Fiscale | Colonna B: Cognome | Colonna C: Nome<br>
                Colonna G: Indirizzo | Colonna H: Citt√† | Colonna I: Provincia | Colonna J: CAP
            </div>
            <input type="file" id="iscrizioniFile" accept=".xlsx,.xls">
            <button onclick="loadIscrizioni()">Carica Iscrizioni</button>
            <div id="iscrizioniResult"></div>
        </div>
        
        <!-- Step 2: Carica movimenti bancari -->
        <div class="step inactive" id="step2">
            <h2>Step 2: Carica Movimenti Bancari</h2>
            <div class="info-box">
                <strong>Nota importante:</strong> Gli importi nei movimenti bancari sono considerati come <strong>TOTALI</strong> (inclusi eventuali rimborsi spese).<br>
                Il sistema calcoler√† automaticamente rimborsi spese e ritenute.
            </div>
            <input type="file" id="movimentiFile" accept=".xlsx,.xls" disabled>
            <button onclick="loadMovimenti()" disabled id="loadMovimentiBtn">Carica Movimenti</button>
            <div id="movimentiResult"></div>
        </div>
        
        <!-- Step 3: Matching e generazione -->
        <div class="step inactive" id="step3">
            <h2>Step 3: Matching e Generazione Ricevute</h2>
            <button onclick="performMatching()" disabled id="matchBtn">Esegui Matching</button>
            <button onclick="generateReceipts()" disabled id="generateBtn">Genera Ricevute</button>
            
            <div style="margin-top: 10px;">
                <button onclick="createZipWithPDFs()" id="downloadBtn" 
                        style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Crea ZIP con PDF
                </button>
                
                <button onclick="exportToExcel()" 
                        style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Esporta Excel
                </button>
                
                <button onclick="resetAllCounters()" 
                        style="background: #fd7e14; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Reset Numerazione
                </button>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="downloadArea"></div>
            
            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="showTab('matching')">Risultati Matching</button>
                <button class="tab" onclick="showTab('preview')">Anteprima Ricevute</button>
            </div>
            
            <div id="matchingTab" class="tab-content active">
                <div id="matchingResult"></div>
            </div>
            
            <div id="previewTab" class="tab-content">
                <div id="previewArea"></div>
            </div>
        </div>
    </div>
    
    <div id="receiptsContainer"></div>
    
    <script>
        let iscrizioniData = [];
        let movimentiData = [];
        let results = [];
        
        // Memoria locale per numeri progressivi e importi annuali
        function saveToLocalStorage() {
            localStorage.setItem('numeroRicevutaPerCF', JSON.stringify(numeroRicevutaPerCF));
            localStorage.setItem('importiAnnualiPerCF', JSON.stringify(importiAnnualiPerCF));
        }
        
        let numeroRicevutaPerCF = JSON.parse(localStorage.getItem('numeroRicevutaPerCF')) || {};
        let importiAnnualiPerCF = JSON.parse(localStorage.getItem('importiAnnualiPerCF')) || {};
        
        function getNextReceiptNumber(cf) {
            if (!numeroRicevutaPerCF[cf]) {
                numeroRicevutaPerCF[cf] = 0;
            }
            numeroRicevutaPerCF[cf]++;
            saveToLocalStorage();
            return numeroRicevutaPerCF[cf];
        }
        
        function getCurrentReceiptNumber(cf) {
            return numeroRicevutaPerCF[cf] || 0;
        }
        
        function resetAllCounters() {
            if (confirm('Sei sicuro di voler resettare tutti i numeri progressivi delle ricevute e gli importi annuali?')) {
                numeroRicevutaPerCF = {};
                importiAnnualiPerCF = {};
                localStorage.removeItem('numeroRicevutaPerCF');
                localStorage.removeItem('importiAnnualiPerCF');
                alert('Numeri progressivi e importi annuali resettati!');
            }
        }
        
        function checkAndUpdateAnnualAmount(cf, compensoNetto) {
            if (!importiAnnualiPerCF[cf]) {
                importiAnnualiPerCF[cf] = 0;
            }
            
            const totaleAttuale = importiAnnualiPerCF[cf];
            const nuovoTotale = totaleAttuale + compensoNetto;
            
            importiAnnualiPerCF[cf] = nuovoTotale;
            saveToLocalStorage();
            
            if (totaleAttuale <= 2500 && nuovoTotale > 2500) {
                return {
                    superaLimite: true,
                    totaleAttuale: totaleAttuale,
                    nuovoTotale: nuovoTotale
                };
            }
            
            return {
                superaLimite: false,
                totaleAttuale: totaleAttuale,
                nuovoTotale: nuovoTotale
            };
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        function loadIscrizioni() {
            const file = document.getElementById('iscrizioniFile').files[0];
            if (!file) {
                alert('Seleziona un file Excel con le iscrizioni');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Cerca specificamente il foglio "ISCRIZIONI"
                    let targetSheet = null;
                    if (workbook.Sheets['ISCRIZIONI']) {
                        targetSheet = workbook.Sheets['ISCRIZIONI'];
                    } else if (workbook.Sheets['Iscrizioni']) {
                        targetSheet = workbook.Sheets['Iscrizioni'];
                    } else if (workbook.Sheets['iscrizioni']) {
                        targetSheet = workbook.Sheets['iscrizioni'];
                    } else {
                        // Se non trova il foglio ISCRIZIONI, mostra tutti i fogli disponibili
                        alert(`Foglio "ISCRIZIONI" non trovato!\nFogli disponibili: ${workbook.SheetNames.join(', ')}\nAssicurati che il foglio si chiami esattamente "ISCRIZIONI"`);
                        return;
                    }
                    
                    iscrizioniData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                    
                    // Converti array in oggetti con le chiavi delle colonne
                    const processedData = [];
                    for (let i = 0; i < iscrizioniData.length; i++) {
                        const row = iscrizioniData[i];
                        if (row.length > 0) {
                            processedData.push({
                                A: row[0], // CF
                                B: row[1], // Cognome
                                C: row[2], // Nome
                                D: row[3],
                                E: row[4],
                                F: row[5],
                                G: row[6], // Indirizzo
                                H: row[7], // Citt√†
                                I: row[8], // Provincia
                                J: row[9], // CAP
                                W: row[22] // Colonna W = NOME + COGNOME (indice 22 perch√© W √® la 23a lettera)
                            });
                        }
                    }
                    iscrizioniData = processedData.filter(row => row.A); // Filtra righe con CF
                    
                    const resultDiv = document.getElementById('iscrizioniResult');
                    resultDiv.innerHTML = `
                        <div class="success-box">
                            ‚úì File caricato con successo!<br>
                            <strong>${iscrizioniData.length}</strong> artisti trovati
                        </div>
                    `;
                    
                    // Abilita step 2
                    document.getElementById('step2').classList.remove('inactive');
                    document.getElementById('movimentiFile').disabled = false;
                    document.getElementById('loadMovimentiBtn').disabled = false;
                    
                } catch (error) {
                    document.getElementById('iscrizioniResult').innerHTML = `
                        <div class="error-box">
                            ‚úó Errore nel caricamento: ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function loadMovimenti() {
            const file = document.getElementById('movimentiFile').files[0];
            if (!file) {
                alert('Seleziona un file Excel con i movimenti bancari');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    movimentiData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    const resultDiv = document.getElementById('movimentiResult');
                    resultDiv.innerHTML = `
                        <div class="success-box">
                            ‚úì File caricato con successo!<br>
                            <strong>${movimentiData.length}</strong> movimenti trovati
                        </div>
                    `;
                    
                    // Abilita step 3
                    document.getElementById('step3').classList.remove('inactive');
                    document.getElementById('matchBtn').disabled = false;
                    
                } catch (error) {
                    document.getElementById('movimentiResult').innerHTML = `
                        <div class="error-box">
                            ‚úó Errore nel caricamento: ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function normalizeString(str) {
            if (!str) return '';
            return str.toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '');
        }
        
        function findBestMatch(movimento, iscrizioni) {
            const controparteColumns = ['CONTROPARTE', 'Controparte', 'controparte'];
            let controparte = null;
            
            for (let col of controparteColumns) {
                if (movimento[col]) {
                    controparte = movimento[col];
                    break;
                }
            }
            
            if (!controparte) return null;
            
            const controparteNorm = normalizeString(controparte);
            
            for (let isc of iscrizioni) {
                // Prova prima con la colonna W (NOME + COGNOME)
                if (isc.W) {
                    const nomeCognomeNorm = normalizeString(isc.W);
                    if (nomeCognomeNorm && (
                        controparteNorm.includes(nomeCognomeNorm) || 
                        nomeCognomeNorm.includes(controparteNorm) ||
                        controparteNorm === nomeCognomeNorm
                    )) {
                        return isc;
                    }
                }
                
                // Se non funziona con W, prova con B e C separate
                if (isc.B && isc.C) {
                    const nomeNorm = normalizeString(isc.C);
                    const cognomeNorm = normalizeString(isc.B);
                    
                    if (nomeNorm && cognomeNorm && (
                        (controparteNorm.includes(nomeNorm) && controparteNorm.includes(cognomeNorm)) ||
                        controparteNorm === (nomeNorm + cognomeNorm) ||
                        controparteNorm === (cognomeNorm + nomeNorm)
                    )) {
                        return isc;
                    }
                }
            }
            
            return null;
        }
        
        function getImportoFromMovimento(movimento) {
            // Priorit√† agli addebiti invece che agli accrediti
            const importoColumns = ['ADDEBITI', 'Addebiti', 'ADDEBITO', 'Addebito', 'IMPORTO', 'Importo', 'ACCREDITI', 'Accrediti'];
            
            for (let col of importoColumns) {
                if (movimento[col] !== undefined && movimento[col] !== null) {
                    let value = movimento[col];
                    if (typeof value === 'string') {
                        value = value.replace(/[^\d,-]/g, '').replace(',', '.');
                    }
                    return Math.abs(parseFloat(value)) || 0;
                }
            }
            return 0;
        }
        
        function getDataFromMovimento(movimento) {
            const dateColumns = ['DATA', 'Data', 'DATA VALUTA', 'Data Valuta', 'DATA OPERAZIONE', 'Data Operazione'];
            
            for (let col of dateColumns) {
                if (movimento[col]) {
                    let dateValue = movimento[col];
                    
                    if (dateValue instanceof Date) return dateValue;
                    
                    if (typeof dateValue === 'number') {
                        const excelEpoch = new Date(1900, 0, 1);
                        const days = dateValue - 2;
                        return new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                    }
                    
                    if (typeof dateValue === 'string') {
                        const italianMatch = dateValue.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                        if (italianMatch) {
                            return new Date(italianMatch[3], italianMatch[2] - 1, italianMatch[1]);
                        }
                        
                        const parsed = new Date(dateValue);
                        if (!isNaN(parsed.getTime())) {
                            return parsed;
                        }
                    }
                }
            }
            
            return new Date();
        }
        
        function performMatching() {
            let matchedMovimenti = [];
            let notMatched = [];
            
            console.log('Inizio matching con', movimentiData.length, 'movimenti e', iscrizioniData.length, 'iscrizioni');
            
            movimentiData.forEach((movimento, index) => {
                const match = findBestMatch(movimento, iscrizioniData);
                const importo = getImportoFromMovimento(movimento);
                const data = getDataFromMovimento(movimento);
                
                if (match) {
                    matchedMovimenti.push({
                        movimento: movimento,
                        iscrizione: match,
                        importoMovimento: importo,
                        data: data
                    });
                } else {
                    notMatched.push({ movimento: movimento });
                }
            });
            
            console.log('Match trovati:', matchedMovimenti.length);
            
            // Raggruppa per persona E per mese
            const gruppiPerPersonaMese = {};
            
            matchedMovimenti.forEach(item => {
                const cf = item.iscrizione.A || `${item.iscrizione.C}_${item.iscrizione.B}`;
                const mese = item.data.getMonth() + 1;
                const anno = item.data.getFullYear();
                const chiaveMese = `${cf}_${anno}_${mese}`;
                
                if (!gruppiPerPersonaMese[chiaveMese]) {
                    gruppiPerPersonaMese[chiaveMese] = {
                        iscrizione: item.iscrizione,
                        movimenti: [],
                        totaleMovimenti: 0,
                        mese: mese,
                        anno: anno,
                        cf: cf
                    };
                }
                
                gruppiPerPersonaMese[chiaveMese].movimenti.push(item.movimento);
                gruppiPerPersonaMese[chiaveMese].totaleMovimenti += item.importoMovimento;
            });
            
            // Gestione compensazioni tra mesi
            const gruppiPerCF = {};
            Object.values(gruppiPerPersonaMese).forEach(gruppo => {
                if (!gruppiPerCF[gruppo.cf]) {
                    gruppiPerCF[gruppo.cf] = [];
                }
                gruppiPerCF[gruppo.cf].push(gruppo);
            });
            
            results = [];
            
            Object.values(gruppiPerCF).forEach(gruppiPersona => {
                gruppiPersona.sort((a, b) => {
                    if (a.anno !== b.anno) return a.anno - b.anno;
                    return a.mese - b.mese;
                });
                
                let creditoResiduo = 0;
                
                gruppiPersona.forEach(gruppo => {
                    let totaleNetto = gruppo.totaleMovimenti + creditoResiduo;
                    
                    if (totaleNetto > 0) {
                        // Calcola rimborso spese
                        let rimborsoSpese = 0;
                        if (totaleNetto >= 500) {
                            rimborsoSpese = 200;
                        } else if (totaleNetto >= 300) {
                            rimborsoSpese = 100;
                        } else if (totaleNetto >= 100) {
                            rimborsoSpese = 40;
                        }
                        
                        const compensoNetto = totaleNetto - rimborsoSpese;
                        const compensoLordo = compensoNetto / 0.8;
                        
                        results.push({
                            nome: gruppo.iscrizione.C,
                            cognome: gruppo.iscrizione.B,
                            codiceFiscale: gruppo.iscrizione.A,
                            indirizzo: gruppo.iscrizione.G,
                            cap: gruppo.iscrizione.J,
                            citta: gruppo.iscrizione.H,
                            provincia: gruppo.iscrizione.I,
                            compenso: compensoLordo,
                            rimborsoSpese: rimborsoSpese,
                            movimentoBancario: totaleNetto,
                            mese: gruppo.mese,
                            anno: gruppo.anno,
                            movimenti: gruppo.movimenti
                        });
                        
                        creditoResiduo = 0;
                    } else if (totaleNetto < 0) {
                        creditoResiduo = totaleNetto;
                    }
                });
            });
            
            // Mostra risultati
            const resultDiv = document.getElementById('matchingResult');
            let html = `
                <div class="info-box">
                    <strong>Risultati del matching:</strong><br>
                    ‚úì Ricevute da generare: ${results.length}<br>
                    ‚úì Movimenti matchati: ${matchedMovimenti.length}<br>
                    ‚úó Non matchati: ${notMatched.length}
                </div>
            `;
            
            if (results.length > 0) {
                html += `
                    <h4>Ricevute da generare (divise per mese):</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Cognome</th>
                                <th>CF</th>
                                <th>Mese/Anno</th>
                                <th>N¬∞ Mov.</th>
                                <th>Totale</th>
                                <th>Rimborso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                results.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.nome || ''}</td>
                            <td>${item.cognome || ''}</td>
                            <td>${item.codiceFiscale || ''}</td>
                            <td>${item.mese}/${item.anno}</td>
                            <td>${item.movimenti.length}</td>
                            <td>‚Ç¨ ${item.movimentoBancario.toFixed(2)}</td>
                            <td>‚Ç¨ ${item.rimborsoSpese.toFixed(2)}</td>
                            <td><span class="match-status match-found">OK</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('generateBtn').disabled = false;
            }
            
            if (notMatched.length > 0) {
                html += `
                    <h4>Movimenti non matchati:</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Controparte</th>
                                <th>Importo</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                notMatched.forEach(item => {
                    const controparte = item.movimento.CONTROPARTE || item.movimento.Controparte || 'N/D';
                    const importo = getImportoFromMovimento(item.movimento);
                    
                    html += `
                        <tr>
                            <td>${controparte}</td>
                            <td>‚Ç¨ ${importo.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            resultDiv.innerHTML = html;
        }
        
        function generateReceipts() {
            if (results.length === 0) {
                alert('Nessun match trovato per generare ricevute');
                return;
            }
            
            const container = document.getElementById('receiptsContainer');
            const previewContainer = document.getElementById('previewArea');
            
            container.innerHTML = '';
            previewContainer.innerHTML = '<h4>Anteprima Ricevute Generate:</h4>';
            
            let alertiSuperamento = [];
            
            results.forEach((person, index) => {
                // Controllo limite ‚Ç¨2.500
                const compensoNetto = person.compenso * 0.8;
                const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                const risultatoControllo = checkAndUpdateAnnualAmount(cfKey, compensoNetto);
                
                if (risultatoControllo.superaLimite) {
                    alertiSuperamento.push({
                        nome: person.nome,
                        cognome: person.cognome,
                        cf: person.codiceFiscale,
                        totalePrec: risultatoControllo.totaleAttuale,
                        nuovoTotale: risultatoControllo.nuovoTotale,
                        compensoRicevuta: compensoNetto
                    });
                }
                
                const receipt = generateReceipt(person);
                container.innerHTML += receipt;
                
                // Anteprima
                const numeroRicevuta = getCurrentReceiptNumber(cfKey);
                const previewItem = document.createElement('div');
                previewItem.style.cssText = 'border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9;';
                
                let warningHtml = '';
                if (risultatoControllo.superaLimite) {
                    warningHtml = '<br><span style="color: red; font-weight: bold;">‚ö†Ô∏è ATTENZIONE: Supera limite ‚Ç¨2500!</span>';
                }
                
                const mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                
                previewItem.innerHTML = `
                    <strong>#${numeroRicevuta} - ${person.nome} ${person.cognome}</strong><br>
                    CF: ${person.codiceFiscale}<br>
                    Periodo: ${mesi[person.mese]} ${person.anno}<br>
                    ${person.movimenti.length > 1 ? `Somma di ${person.movimenti.length} movimenti<br>` : ''}
                    Totale movimenti: ‚Ç¨ ${person.movimentoBancario.toFixed(2)}<br>
                    ${person.rimborsoSpese > 0 ? `Rimborso spese: ‚Ç¨ ${person.rimborsoSpese.toFixed(2)}<br>` : ''}
                    Compenso lordo: ‚Ç¨ ${person.compenso.toFixed(2)}<br>
                    <strong>Netto a pagare: ‚Ç¨ ${(person.compenso * 0.8 + person.rimborsoSpese).toFixed(2)}</strong><br>
                    Totale annuale: ‚Ç¨ ${risultatoControllo.nuovoTotale.toFixed(2)}${warningHtml}
                `;
                previewContainer.appendChild(previewItem);
            });
            
            // Mostra alert superamento
            if (alertiSuperamento.length > 0) {
                let messaggioAlert = '‚ö†Ô∏è ATTENZIONE - SUPERAMENTO LIMITE ‚Ç¨2500 NETTI ANNUALI!\n\n';
                messaggioAlert += 'I seguenti artisti superano il limite con questa ricevuta:\n\n';
                
                alertiSuperamento.forEach(alert => {
                    messaggioAlert += `${alert.nome} ${alert.cognome} (CF: ${alert.cf})\n`;
                    messaggioAlert += `- Totale precedente: ‚Ç¨ ${alert.totalePrec.toFixed(2)}\n`;
                    messaggioAlert += `- Compenso questa ricevuta: ‚Ç¨ ${alert.compensoRicevuta.toFixed(2)}\n`;
                    messaggioAlert += `- NUOVO TOTALE: ‚Ç¨ ${alert.nuovoTotale.toFixed(2)}\n\n`;
                });
                
                messaggioAlert += 'Questi artisti potrebbero dover aprire Partita IVA!';
                alert(messaggioAlert);
            }
            
            // Abilita download
            document.getElementById('downloadBtn').disabled = false;
            
            // Mostra tab anteprima - correzione
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Attiva specificamente il tab anteprima
            const tabs = document.querySelectorAll('.tab');
            const previewTab = tabs[1]; // Il secondo tab √® l'anteprima
            previewTab.classList.add('active');
            document.getElementById('previewTab').classList.add('active');
            
            // Scorri verso l'anteprima
            document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateReceipt(person) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            const ritenuta = person.compenso * 0.20;
            const compensoNetto = person.compenso - ritenuta;
            const nettoPagare = compensoNetto + person.rimborsoSpese;
            const needsStamp = person.compenso > 77.47;
            
            // Ottieni numero progressivo
            const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
            const numeroRicevuta = getNextReceiptNumber(cfKey);
            
            const mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                         'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            // Formato con o senza rimborso spese
            if (person.rimborsoSpese === 0) {
                return `
                    <div class="ricevuta">
                        <div class="ricevuta-header">
                            <div style="text-transform: uppercase;">
                                ${person.nome} ${person.cognome}<br>
                                ${person.indirizzo}<br>
                                ${person.cap} ‚Äì ${person.citta} ‚Äì ${person.provincia}<br>
                                C.F. ${person.codiceFiscale}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="ricevuta-info">
                            <div>
                                <strong>SPETT.LE</strong><br>
                                OKL SRL<br>
                                VIA MONTE PASUBIO<br>
                                36010 ‚Äì ZANE' ‚Äì (VI)<br>
                                P.I. 04433920248
                            </div>
                            <div style="text-align: right;">
                                <strong>RICEVUTA NUMERO:</strong> ${numeroRicevuta}<br>
                                <strong>DATA:</strong> ${dateStr}
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <strong>DESCRIZIONE ATTIVIT√Ä:</strong> COMPENSO PER PRESTAZIONE ARTISTICA DELLO SPETTACOLO - ${mesi[person.mese]} ${person.anno}
                        </div>
                        
                        <table class="ricevuta-table">
                            <thead>
                                <tr>
                                    <th>DESCRIZIONE COMPENSO</th>
                                    <th style="text-align: right;">IMPORTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE</td>
                                    <td class="amount">‚Ç¨ ${person.compenso.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: right;"><strong>COMPENSO LORDO</strong></td>
                                    <td class="amount"><strong>‚Ç¨ ${person.compenso.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td>RITENUTA D'ACCONTO IRPEF 20% - Art. 25 DPR 633/72</td>
                                    <td class="amount">‚Ç¨ ${ritenuta.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: right;"><strong>NETTO A PAGARE</strong></td>
                                    <td class="amount"><strong>‚Ç¨ ${compensoNetto.toFixed(2)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="ricevuta-footer">
                            <p><em>${needsStamp ? 'Imposta di bollo da 2,00 euro assolta sull\'originale per importi maggiori di 77,47 euro.' : ''}</em></p>
                            <p><em>Operazione esclusa da IVA ai sensi dell'art. 5 del D.P.R. 633/72.</em></p>
                            
                            <p style="margin-top: 20px;">
                                ‚Ä¢ Il sottoscritto dichiara che, nell'anno solare in corso, <strong>alla data odierna</strong>:
                            </p>
                            <p>
                                non ha conseguito redditi derivanti dall'esercizio di attivit√† di lavoro autonomo occasionale pari o eccedenti<br>
                                i 5.000 euro e <strong>si obbliga a comunicare l'eventuale superamento</strong> del limite annuo, anche successivamente<br>
                                alla data odierna.
                            </p>
                            
                            <div class="signature-line">
                                <p>_________________________<br>
                                <span class="signature">${person.nome} ${person.cognome}</span></p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="ricevuta">
                        <div class="ricevuta-header">
                            <div style="text-transform: uppercase;">
                                ${person.nome} ${person.cognome}<br>
                                ${person.indirizzo}<br>
                                ${person.cap} ‚Äì ${person.citta} ‚Äì ${person.provincia}<br>
                                ${person.codiceFiscale}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="ricevuta-info">
                            <div>
                                <strong>SPETT.LE</strong><br>
                                OKL SRL<br>
                                VIA MONTE PASUBIO<br>
                                36010 ‚Äì ZANE' ‚Äì (VI)<br>
                                P.I. 04433920248
                            </div>
                            <div style="text-align: right;">
                                <strong>RICEVUTA NUM:</strong> ${numeroRicevuta}<br>
                                <strong>DATA:</strong> ${dateStr}
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <strong>DESCRIZIONE ATTIVIT√Ä:</strong> COMPENSO PER PRESTAZIONE ARTISTICA DELLO SPETTACOLO - ${mesi[person.mese]} ${person.anno}
                        </div>
                        
                        <table class="ricevuta-table">
                            <thead>
                                <tr>
                                    <th>DESCRIZIONE COMPENSO</th>
                                    <th style="text-align: right;">IMPORTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE</td>
                                    <td class="amount">${person.compenso.toFixed(2)} ‚Ç¨</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td style="text-align: center;"><strong>COMPENSO LORDO</strong></td>
                                    <td class="amount"><strong>${person.compenso.toFixed(2)} ‚Ç¨</strong></td>
                                </tr>
                                <tr>
                                    <td>RITENUTA D'ACCONTO IRPEF 20% - Art. 25 DPR 633/72</td>
                                    <td class="amount">${ritenuta.toFixed(2)} ‚Ç¨</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td>COMPENSO NETTO</td>
                                    <td class="amount">${compensoNetto.toFixed(2)} ‚Ç¨</td>
                                </tr>
                                <tr>
                                    <td>RIMBORSO SPESE</td>
                                    <td class="amount">${person.rimborsoSpese.toFixed(2)} ‚Ç¨</td>
                                </tr>
                                <tr style="background-color: #e0e0e0;">
                                    <td style="text-align: center;"><strong>NETTO A PAGARE (COMPRENSIVO DI SPESE)</strong></td>
                                    <td class="amount"><strong>${nettoPagare.toFixed(2)} ‚Ç¨</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="ricevuta-footer">
                            <p><em>Imposta di bollo da 2,00 euro assolta sull'originale per importi maggiori di 77,47 euro.</em></p>
                            <p><em>Operazione esclusa da IVA ai sensi dell'art. 5 del D.P.R. 633/72.</em></p>
                            
                            <p style="margin-top: 20px;">
                                ‚Ä¢ Il sottoscritto dichiara che, nell'anno solare in corso, <strong>alla data odierna</strong>:
                            </p>
                            <p>
                                non ha conseguito redditi derivanti dall'esercizio di attivit√† di lavoro autonomo occasionale pari o eccedenti<br>
                                i 5.000 euro e <strong>si obbliga a comunicare l'eventuale superamento</strong> del limite annuo, anche successivamente<br>
                                alla data odierna.
                            </p>
                            
                            <div class="signature-line">
                                <p style="text-align: center;">_________________________<br>
                                <span class="signature">${person.nome} ${person.cognome}</span></p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateProgressBar(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
        }
        
        function createZipWithPDFs() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            btn.innerHTML = '‚è≥ Generazione ZIP in corso...';
            btn.disabled = true;
            document.getElementById('progressBar').style.display = 'block';

            try {
                const zip = new JSZip();
                const folder = zip.folder("Ricevute");
                let progress = 0;

                results.forEach((person, index) => {
                    const receiptHtml = generateReceipt(person);
                    const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                    const receiptNumber = getCurrentReceiptNumber(cfKey);
                    
                    // Genera PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Converti HTML in testo per il PDF
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = receiptHtml;
                    const text = tempDiv.textContent || tempDiv.innerText || '';
                    
                    pdf.setFontSize(10);
                    const lines = pdf.splitTextToSize(text, 180);
                    pdf.text(lines, 10, 20);

                    const fileName = `Ricevuta_${receiptNumber}_${person.cognome}_${person.nome}_${person.codiceFiscale}.pdf`;
                    folder.file(fileName, pdf.output('blob'));

                    progress = ((index + 1) / results.length) * 100;
                    updateProgressBar(progress);
                });

                // Genera e mostra link per download
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const currentDate = new Date().toISOString().split('T')[0];
                    
                    // Mostra link di download
                    const downloadArea = document.getElementById('downloadArea');
                    downloadArea.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin: 10px 0; text-align: center;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úì ZIP generato con successo!</h4>
                            <a href="${url}" download="Ricevute_${currentDate}.zip" 
                               style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                               üì• Clicca qui per scaricare il file ZIP
                            </a>
                        </div>
                    `;
                    
                    btn.innerHTML = 'üì• Crea ZIP con PDF';
                    btn.disabled = false;
                    document.getElementById('progressBar').style.display = 'none';
                    
                    // Scroll al link
                    downloadArea.scrollIntoView({ behavior: 'smooth' });
                });

            } catch (error) {
                console.error('Errore nella generazione:', error);
                alert('Errore nella generazione del ZIP: ' + error.message);
                btn.innerHTML = 'üì• Crea ZIP con PDF';
                btn.disabled = false;
                document.getElementById('progressBar').style.display = 'none';
            }
        }
        
        function exportToExcel() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            const excelData = [];
            
            // Intestazione
            excelData.push([
                'Id Paese',
                'Partita Iva', 
                'Codice Fiscale',
                'Denominazione (nome + cognome)',
                'Cognome',
                'Nome',
                'Indirizzo',
                'Num. civico',
                'CAP',
                'Comune',
                'Provincia',
                'Causale (sempre 135)',
                'Sezionale (sempre 4)',
                'Tipo Doc. (sempre TF01)',
                'Data Doc. (data del pagamento)',
                'Numero Doc. (progressivo)',
                'Data doc. fattura origine (data del pagamento)',
                'Num. doc. fattura origine (sempre 1)',
                'Descr. Articolo1 (sempre "COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE")',
                'Imponibile1 (totale escluso ritenuta e rimborso)',
                'Aliquota IVA1 (sempre 0)',
                'Natura IVA1 (sempre N2)',
                'Codice IVA1 (sempre NI)',
                'Imposta1 (SEMPRE 0)',
                'Totale Imponibile (uguale a imponibile1)',
                'Totale Imposta (sempre 0)',
                'Totale Documento (come Imponibile1)',
                'Esigibilita\' IVA (sempre I)'
            ]);

            // Dati
            results.forEach(person => {
                const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                const receiptNumber = getCurrentReceiptNumber(cfKey);
                const dataDoc = new Date().toLocaleDateString('it-IT');
                const denominazione = `${person.nome} ${person.cognome}`;
                
                // Separa indirizzo e numero civico
                const indirizzoCompleto = person.indirizzo || '';
                const indirizzoParti = indirizzoCompleto.split(' ');
                let indirizzo = '';
                let numCivico = '';
                
                if (indirizzoParti.length > 0) {
                    const ultimaParte = indirizzoParti[indirizzoParti.length - 1];
                    if (/^\d+[a-zA-Z]?$/.test(ultimaParte)) {
                        numCivico = ultimaParte;
                        indirizzo = indirizzoParti.slice(0, -1).join(' ');
                    } else {
                        indirizzo = indirizzoCompleto;
                    }
                }

                excelData.push([
                    'IT', // Id Paese
                    '', // Partita Iva
                    person.codiceFiscale,
                    denominazione,
                    person.cognome,
                    person.nome,
                    indirizzo,
                    numCivico,
                    person.cap || '',
                    person.citta || '',
                    person.provincia || '',
                    '135', // Causale
                    '4', // Sezionale
                    'TF01', // Tipo Doc
                    dataDoc, // Data Doc
                    receiptNumber, // Numero Doc
                    dataDoc, // Data doc fattura origine
                    '1', // Num doc fattura origine
                    'COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE', // Descr Articolo1
                    person.compenso.toFixed(2), // Imponibile1 (compenso lordo)
                    '0', // Aliquota IVA1
                    'N2', // Natura IVA1
                    'NI', // Codice IVA1
                    '0', // Imposta1
                    person.compenso.toFixed(2), // Totale Imponibile
                    '0', // Totale Imposta
                    person.compenso.toFixed(2), // Totale Documento
                    'I' // Esigibilita IVA
                ]);
            });

            // Crea e scarica il file Excel
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Export Ricevute");
            
            const currentDate = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Export_Ricevute_${currentDate}.xlsx`);
        }
    </script>
</body>
</html>
