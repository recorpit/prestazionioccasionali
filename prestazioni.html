<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Ricevute per Prestazioni Artistiche</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #333;
        }
        
        .step {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .step.inactive {
            border-left-color: #ccc;
            opacity: 0.6;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="file"] {
            display: block;
            margin: 10px 0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
        }
        
        .success-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
        }
        
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .match-status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .match-found {
            background-color: #4CAF50;
            color: white;
        }
        
        .match-not-found {
            background-color: #f44336;
            color: white;
        }
        
        /* Stili per la ricevuta */
        .ricevuta {
            background-color: white;
            padding: 40px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            page-break-after: always;
            min-height: 297mm;
            width: 210mm;
            margin: 0 auto 20px;
            box-sizing: border-box;
        }
        
        .ricevuta-header {
            margin-bottom: 30px;
        }
        
        .ricevuta-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .ricevuta-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .ricevuta-table th {
            background-color: #003d7a;
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .ricevuta-table td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .ricevuta-table .amount {
            text-align: right;
        }
        
        .ricevuta-footer {
            margin-top: 30px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .signature-line {
            margin-top: 50px;
            text-align: right;
        }
        
        .signature {
            font-family: "Brush Script MT", cursive;
            color: #003d7a;
            font-size: 18px;
            font-style: italic;
        }
        
        .no-print {
            display: block;
        }
        
        @media print {
            body {
                margin: 0;
                background-color: white;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
            }
            
            .no-print {
                display: none !important;
            }
            
            .ricevuta {
                border: none;
                margin: 0;
                padding: 20mm;
            }
        }
        
        #previewArea {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab.active {
            border-bottom: 2px solid #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container no-print">
        <h1>Generatore Ricevute per Prestazioni Artistiche</h1>
        <p>Sistema automatizzato per generare ricevute incrociando dati anagrafici e movimenti bancari</p>
        
        <!-- Step 1: Carica file iscrizioni -->
        <div class="step" id="step1">
            <h2>Step 1: Carica File Iscrizioni</h2>
            <div class="info-box">
                <strong>Formato richiesto:</strong> File Excel (.xlsx) con struttura:<br>
                Colonna A: Codice Fiscale | Colonna B: Cognome | Colonna C: Nome<br>
                Colonna G: Indirizzo | Colonna H: Città | Colonna I: Provincia | Colonna J: CAP
            </div>
            <input type="file" id="iscrizioniFile" accept=".xlsx,.xls">
            <button onclick="loadIscrizioni()">Carica Iscrizioni</button>
            <div id="iscrizioniResult"></div>
        </div>
        
        <!-- Step 2: Carica movimenti bancari -->
        <div class="step inactive" id="step2">
            <h2>Step 2: Carica Movimenti Bancari</h2>
            <div class="info-box">
                <strong>Nota importante:</strong> Gli importi nei movimenti bancari sono considerati come <strong>TOTALI</strong> (inclusi eventuali rimborsi spese).<br>
                Il sistema calcolerà automaticamente rimborsi spese e ritenute.
            </div>
            <input type="file" id="movimentiFile" accept=".xlsx,.xls" disabled>
            <button onclick="loadMovimenti()" disabled id="loadMovimentiBtn">Carica Movimenti</button>
            <div id="movimentiResult"></div>
        </div>
        
        <!-- Step 3: Matching e generazione -->
        <div class="step inactive" id="step3">
            <h2>Step 3: Matching e Generazione Ricevute</h2>
            <button onclick="performMatching()" disabled id="matchBtn">Esegui Matching</button>
            <button onclick="generateReceipts()" disabled id="generateBtn">Genera Ricevute</button>
            
            <div style="margin-top: 10px;">
                <button onclick="createZipWithPDFs()" id="downloadBtn" 
                        style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Crea ZIP con PDF
                </button>
                
                <button onclick="generatePDFPreviews()" id="pdfPreviewBtn"
                        style="background: #6f42c1; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;" disabled>
                    Anteprima PDF
                </button>
                
                <button onclick="exportToExcel()" 
                        style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Esporta Excel
                </button>
                
                <button onclick="exportToExcelByMonth()" 
                        style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Esporta Excel per Mese
                </button>
                
                <button onclick="resetAllCounters()" 
                        style="background: #fd7e14; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                    Reset Numerazione
                </button>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="downloadArea"></div>
            
            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="showTab('matching')">Risultati Matching</button>
                <button class="tab" onclick="showTab('preview')">Anteprima Ricevute</button>
                <button class="tab" onclick="showTab('pdfpreview')">Anteprima PDF</button>
            </div>
            
            <div id="matchingTab" class="tab-content active">
                <div id="matchingResult"></div>
            </div>
            
            <div id="previewTab" class="tab-content">
                <div id="previewArea"></div>
            </div>
            
            <div id="pdfpreviewTab" class="tab-content">
                <div id="pdfPreviewArea">
                    <p style="text-align: center; color: #666; padding: 20px;">
                        Genera prima le ricevute, poi clicca su "Anteprima PDF" per vedere come appariranno i PDF.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="receiptsContainer"></div>
    
    <script>
        let iscrizioniData = [];
        let movimentiData = [];
        let results = [];
        
        // Memoria locale per numeri progressivi e importi annuali
        function saveToLocalStorage() {
            localStorage.setItem('numeroRicevutaPerCF', JSON.stringify(numeroRicevutaPerCF));
            localStorage.setItem('importiAnnualiPerCF', JSON.stringify(importiAnnualiPerCF));
        }
        
        let numeroRicevutaPerCF = JSON.parse(localStorage.getItem('numeroRicevutaPerCF')) || {};
        let importiAnnualiPerCF = JSON.parse(localStorage.getItem('importiAnnualiPerCF')) || {};
        
        function getNextReceiptNumber(cf) {
            if (!numeroRicevutaPerCF[cf]) {
                numeroRicevutaPerCF[cf] = 0;
            }
            numeroRicevutaPerCF[cf]++;
            saveToLocalStorage();
            return numeroRicevutaPerCF[cf];
        }
        
        function getCurrentReceiptNumber(cf) {
            return numeroRicevutaPerCF[cf] || 0;
        }
        
        function resetAllCounters() {
            if (confirm('Sei sicuro di voler resettare tutti i numeri progressivi delle ricevute e gli importi annuali?')) {
                numeroRicevutaPerCF = {};
                importiAnnualiPerCF = {};
                localStorage.removeItem('numeroRicevutaPerCF');
                localStorage.removeItem('importiAnnualiPerCF');
                alert('Numeri progressivi e importi annuali resettati!');
            }
        }
        
        function checkAndUpdateAnnualAmount(cf, compensoNetto) {
            if (!importiAnnualiPerCF[cf]) {
                importiAnnualiPerCF[cf] = 0;
            }
            
            const totaleAttuale = importiAnnualiPerCF[cf];
            const nuovoTotale = totaleAttuale + compensoNetto;
            
            importiAnnualiPerCF[cf] = nuovoTotale;
            saveToLocalStorage();
            
            if (totaleAttuale <= 2500 && nuovoTotale > 2500) {
                return {
                    superaLimite: true,
                    totaleAttuale: totaleAttuale,
                    nuovoTotale: nuovoTotale
                };
            }
            
            return {
                superaLimite: false,
                totaleAttuale: totaleAttuale,
                nuovoTotale: nuovoTotale
            };
        }
        
        async function generatePDFPreviews() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            const btn = document.getElementById('pdfPreviewBtn');
            btn.innerHTML = 'Generazione anteprima...';
            btn.disabled = true;

            const pdfPreviewArea = document.getElementById('pdfPreviewArea');
            pdfPreviewArea.innerHTML = '<h4>Anteprima PDF Generate:</h4>';

            try {
                for (let index = 0; index < Math.min(results.length, 5); index++) { // Mostra max 5 anteprime
                    const person = results[index];
                    
                    // Trova l'elemento HTML della ricevuta corrispondente
                    const receiptElement = document.querySelectorAll('.ricevuta')[index];
                    
                    if (!receiptElement) {
                        console.error(`Ricevuta ${index} non trovata`);
                        continue;
                    }
                    
                    // Genera immagine con html2canvas
                    const canvas = await html2canvas(receiptElement, {
                        scale: 1.5, // Qualità leggermente ridotta per anteprima
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true,
                        allowTaint: false
                    });
                    
                    // Crea elemento anteprima
                    const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                    const receiptNumber = getCurrentReceiptNumber(cfKey);
                    const fileName = `${person.nome}_${person.cognome}_${receiptNumber}.pdf`;
                    
                    const previewDiv = document.createElement('div');
                    previewDiv.style.cssText = 'border: 2px solid #ddd; margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;';
                    
                    const previewImage = canvas.toDataURL('image/png');
                    
                    previewDiv.innerHTML = `
                        <div style="display: flex; align-items: flex-start; gap: 20px;">
                            <div style="flex-shrink: 0;">
                                <h5 style="margin: 0 0 10px 0; color: #333;">
                                    ${fileName}
                                </h5>
                                <img src="${previewImage}" 
                                     style="max-width: 300px; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     alt="Anteprima PDF ${fileName}">
                            </div>
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 10px 0; color: #666;">Dettagli ricevuta:</h6>
                                <div style="font-size: 14px; line-height: 1.5;">
                                    <strong>Nome:</strong> ${person.nome} ${person.cognome}<br>
                                    <strong>CF:</strong> ${person.codiceFiscale}<br>
                                    <strong>Numero ricevuta:</strong> ${receiptNumber}<br>
                                    <strong>Compenso lordo:</strong> € ${person.compenso.toFixed(2)}<br>
                                    ${person.rimborsoSpese > 0 ? `<strong>Rimborso spese:</strong> € ${person.rimborsoSpese.toFixed(2)}<br>` : ''}
                                    <strong>Netto a pagare:</strong> € ${(person.compenso * 0.8 + person.rimborsoSpese).toFixed(2)}
                                </div>
                                <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 4px; font-size: 12px; color: #155724;">
                                    ✓ PDF pronto per il download
                                </div>
                            </div>
                        </div>
                    `;
                    
                    pdfPreviewArea.appendChild(previewDiv);
                }
                
                // Se ci sono più di 5 ricevute, mostra messaggio
                if (results.length > 5) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.cssText = 'text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; margin: 20px 0;';
                    moreDiv.innerHTML = `
                        <strong>Anteprima limitata</strong><br>
                        Mostrate ${Math.min(5, results.length)} di ${results.length} ricevute.<br>
                        Tutte le ${results.length} ricevute saranno incluse nel download ZIP.
                    `;
                    pdfPreviewArea.appendChild(moreDiv);
                }

            } catch (error) {
                console.error('Errore nell\'anteprima PDF:', error);
                pdfPreviewArea.innerHTML = `
                    <div class="error-box">
                        Errore nella generazione dell'anteprima: ${error.message}
                    </div>
                `;
            } finally {
                btn.innerHTML = 'Anteprima PDF';
                btn.disabled = false;
                
                // Attiva automaticamente il tab anteprima PDF
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const pdfTab = document.querySelectorAll('.tab')[2]; // Terzo tab
                pdfTab.classList.add('active');
                document.getElementById('pdfpreviewTab').classList.add('active');
                
                pdfPreviewArea.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        function loadIscrizioni() {
            const file = document.getElementById('iscrizioniFile').files[0];
            if (!file) {
                alert('Seleziona un file Excel con le iscrizioni');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Cerca specificamente il foglio "ISCRIZIONI"
                    let targetSheet = null;
                    if (workbook.Sheets['ISCRIZIONI']) {
                        targetSheet = workbook.Sheets['ISCRIZIONI'];
                    } else if (workbook.Sheets['Iscrizioni']) {
                        targetSheet = workbook.Sheets['Iscrizioni'];
                    } else if (workbook.Sheets['iscrizioni']) {
                        targetSheet = workbook.Sheets['iscrizioni'];
                    } else {
                        // Se non trova il foglio ISCRIZIONI, mostra tutti i fogli disponibili
                        alert(`Foglio "ISCRIZIONI" non trovato!\nFogli disponibili: ${workbook.SheetNames.join(', ')}\nAssicurati che il foglio si chiami esattamente "ISCRIZIONI"`);
                        return;
                    }
                    
                    iscrizioniData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                    
                    // Converti array in oggetti con le chiavi delle colonne - STRUTTURA CORRETTA
                    const processedData = [];
                    for (let i = 0; i < iscrizioniData.length; i++) {
                        const row = iscrizioniData[i];
                        if (row.length > 0) {
                            processedData.push({
                                // Struttura corretta del file ISCRIZIONI
                                B: row[1], // Codice Fiscale
                                C: row[2], // Cognome
                                D: row[3], // Nome
                                E: row[4], // Data di nascita
                                F: row[5], // Cittadinanza
                                G: row[6], // Nome d'arte
                                H: row[7], // Via Indirizzo 1
                                I: row[8], // Città
                                J: row[9], // Provincia
                                K: row[10], // CAP
                                L: row[11], // Paese
                                M: row[12], // P.IVA
                                N: row[13], // Mansione
                                O: row[14], // IBAN
                                P: row[15], // BIC
                                Q: row[16], // E-mail
                                R: row[17], // Cellulare
                                S: row[18], // Comune
                                T: row[19]  // Nascita
                            });
                        }
                    }
                    iscrizioniData = processedData.filter(row => row.B); // Filtra righe con CF (ora colonna B)
                    
                    const resultDiv = document.getElementById('iscrizioniResult');
                    resultDiv.innerHTML = `
                        <div class="success-box">
                            ✓ File caricato con successo!<br>
                            <strong>${iscrizioniData.length}</strong> artisti trovati
                        </div>
                    `;
                    
                    // Abilita step 2
                    document.getElementById('step2').classList.remove('inactive');
                    document.getElementById('movimentiFile').disabled = false;
                    document.getElementById('loadMovimentiBtn').disabled = false;
                    
                } catch (error) {
                    document.getElementById('iscrizioniResult').innerHTML = `
                        <div class="error-box">
                            ✗ Errore nel caricamento: ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function loadMovimenti() {
            const file = document.getElementById('movimentiFile').files[0];
            if (!file) {
                alert('Seleziona un file Excel con i movimenti bancari');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    movimentiData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    const resultDiv = document.getElementById('movimentiResult');
                    resultDiv.innerHTML = `
                        <div class="success-box">
                            ✓ File caricato con successo!<br>
                            <strong>${movimentiData.length}</strong> movimenti trovati
                        </div>
                    `;
                    
                    // Abilita step 3
                    document.getElementById('step3').classList.remove('inactive');
                    document.getElementById('matchBtn').disabled = false;
                    
                } catch (error) {
                    document.getElementById('movimentiResult').innerHTML = `
                        <div class="error-box">
                            ✗ Errore nel caricamento: ${error.message}
                        </div>
                    `;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function normalizeString(str) {
            if (!str) return '';
            return str.toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '');
        }
        
        function findBestMatch(movimento, iscrizioni) {
            const controparteColumns = ['CONTROPARTE', 'Controparte', 'controparte'];
            let controparte = null;
            
            for (let col of controparteColumns) {
                if (movimento[col]) {
                    controparte = movimento[col];
                    break;
                }
            }
            
            if (!controparte) return null;
            
            const controparteNorm = normalizeString(controparte);
            
            return iscrizioni.find(isc => {
                // Usa le colonne corrette: C = Cognome, D = Nome
                const cognome = isc.C;
                const nome = isc.D;
                
                if (!nome || !cognome) return false;
                
                const nomeNorm = normalizeString(nome);
                const cognomeNorm = normalizeString(cognome);
                
                // Verifica se la controparte contiene sia nome che cognome
                return (controparteNorm.includes(nomeNorm) && controparteNorm.includes(cognomeNorm)) ||
                       controparteNorm === (nomeNorm + cognomeNorm) ||
                       controparteNorm === (cognomeNorm + nomeNorm);
            });
        }
        
        function getImportoFromMovimento(movimento) {
            // Priorità agli addebiti invece che agli accrediti
            const importoColumns = ['ADDEBITI', 'Addebiti', 'ADDEBITO', 'Addebito', 'IMPORTO', 'Importo', 'ACCREDITI', 'Accrediti'];
            
            for (let col of importoColumns) {
                if (movimento[col] !== undefined && movimento[col] !== null) {
                    let value = movimento[col];
                    if (typeof value === 'string') {
                        value = value.replace(/[^\d,-]/g, '').replace(',', '.');
                    }
                    return Math.abs(parseFloat(value)) || 0;
                }
            }
            return 0;
        }
        
        function getDataFromMovimento(movimento) {
            const dateColumns = ['DATA', 'Data', 'DATA VALUTA', 'Data Valuta', 'DATA OPERAZIONE', 'Data Operazione'];
            
            for (let col of dateColumns) {
                if (movimento[col]) {
                    let dateValue = movimento[col];
                    
                    if (dateValue instanceof Date) return dateValue;
                    
                    if (typeof dateValue === 'number') {
                        const excelEpoch = new Date(1900, 0, 1);
                        const days = dateValue - 2;
                        return new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                    }
                    
                    if (typeof dateValue === 'string') {
                        const italianMatch = dateValue.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                        if (italianMatch) {
                            return new Date(italianMatch[3], italianMatch[2] - 1, italianMatch[1]);
                        }
                        
                        const parsed = new Date(dateValue);
                        if (!isNaN(parsed.getTime())) {
                            return parsed;
                        }
                    }
                }
            }
            
            return new Date();
        }
        
        function performMatching() {
            let matchedMovimenti = [];
            let notMatched = [];
            
            console.log('Inizio matching con', movimentiData.length, 'movimenti e', iscrizioniData.length, 'iscrizioni');
            
            movimentiData.forEach((movimento, index) => {
                const match = findBestMatch(movimento, iscrizioniData);
                const importo = getImportoFromMovimento(movimento);
                const data = getDataFromMovimento(movimento);
                
                if (match) {
                    matchedMovimenti.push({
                        movimento: movimento,
                        iscrizione: match,
                        importoMovimento: importo,
                        data: data
                    });
                } else {
                    notMatched.push({ movimento: movimento });
                }
            });
            
            console.log('Match trovati:', matchedMovimenti.length);
            
            // Raggruppa per persona E per mese
            const gruppiPerPersonaMese = {};
            
            matchedMovimenti.forEach(item => {
                const cf = item.iscrizione.A || `${item.iscrizione.C}_${item.iscrizione.B}`;
                const mese = item.data.getMonth() + 1;
                const anno = item.data.getFullYear();
                const chiaveMese = `${cf}_${anno}_${mese}`;
                
                if (!gruppiPerPersonaMese[chiaveMese]) {
                    gruppiPerPersonaMese[chiaveMese] = {
                        iscrizione: item.iscrizione,
                        movimenti: [],
                        totaleMovimenti: 0,
                        mese: mese,
                        anno: anno,
                        cf: cf
                    };
                }
                
                gruppiPerPersonaMese[chiaveMese].movimenti.push(item.movimento);
                gruppiPerPersonaMese[chiaveMese].totaleMovimenti += item.importoMovimento;
            });
            
            // Gestione compensazioni tra mesi
            const gruppiPerCF = {};
            Object.values(gruppiPerPersonaMese).forEach(gruppo => {
                if (!gruppiPerCF[gruppo.cf]) {
                    gruppiPerCF[gruppo.cf] = [];
                }
                gruppiPerCF[gruppo.cf].push(gruppo);
            });
            
            results = [];
            
            Object.values(gruppiPerCF).forEach(gruppiPersona => {
                gruppiPersona.sort((a, b) => {
                    if (a.anno !== b.anno) return a.anno - b.anno;
                    return a.mese - b.mese;
                });
                
                let creditoResiduo = 0;
                
                gruppiPersona.forEach(gruppo => {
                    let totaleNetto = gruppo.totaleMovimenti + creditoResiduo;
                    
                    if (totaleNetto > 0) {
                        // Calcola rimborso spese
                        let rimborsoSpese = 0;
                        if (totaleNetto >= 500) {
                            rimborsoSpese = 200;
                        } else if (totaleNetto >= 300) {
                            rimborsoSpese = 100;
                        } else if (totaleNetto >= 100) {
                            rimborsoSpese = 40;
                        }
                        
                        const compensoNetto = totaleNetto - rimborsoSpese;
                        const compensoLordo = compensoNetto / 0.8;
                        
                                        results.push({
                            nome: gruppo.iscrizione.D, // Colonna D = Nome
                            cognome: gruppo.iscrizione.C, // Colonna C = Cognome
                            codiceFiscale: gruppo.iscrizione.B, // Colonna B = CF
                            partitaIva: gruppo.iscrizione.M, // Colonna M = P.IVA
                            iban: gruppo.iscrizione.O, // Colonna O = IBAN
                            indirizzo: gruppo.iscrizione.H, // Colonna H = Via Indirizzo 1
                            cap: gruppo.iscrizione.K, // Colonna K = CAP
                            citta: gruppo.iscrizione.I, // Colonna I = Città
                            provincia: gruppo.iscrizione.J, // Colonna J = Provincia
                            compenso: compensoLordo,
                            rimborsoSpese: rimborsoSpese,
                            movimentoBancario: totaleNetto,
                            mese: gruppo.mese,
                            anno: gruppo.anno,
                            movimenti: gruppo.movimenti
                        });
                        
                        creditoResiduo = 0;
                    } else if (totaleNetto < 0) {
                        creditoResiduo = totaleNetto;
                    }
                });
            });
            
            // Mostra risultati
            const resultDiv = document.getElementById('matchingResult');
            let html = `
                <div class="info-box">
                    <strong>Risultati del matching:</strong><br>
                    ✓ Ricevute da generare: ${results.length}<br>
                    ✓ Movimenti matchati: ${matchedMovimenti.length}<br>
                    ✗ Non matchati: ${notMatched.length}
                </div>
            `;
            
            if (results.length > 0) {
                html += `
                    <h4>Ricevute da generare (divise per mese):</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Cognome</th>
                                <th>CF</th>
                                <th>Mese/Anno</th>
                                <th>N° Mov.</th>
                                <th>Totale</th>
                                <th>Rimborso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                results.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.nome || ''}</td>
                            <td>${item.cognome || ''}</td>
                            <td>${item.codiceFiscale || ''}</td>
                            <td>${item.mese}/${item.anno}</td>
                            <td>${item.movimenti.length}</td>
                            <td>€ ${item.movimentoBancario.toFixed(2)}</td>
                            <td>€ ${item.rimborsoSpese.toFixed(2)}</td>
                            <td><span class="match-status match-found">OK</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('generateBtn').disabled = false;
            }
            
            if (notMatched.length > 0) {
                html += `
                    <h4>Movimenti non matchati:</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Controparte</th>
                                <th>Importo</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                notMatched.forEach(item => {
                    const controparte = item.movimento.CONTROPARTE || item.movimento.Controparte || 'N/D';
                    const importo = getImportoFromMovimento(item.movimento);
                    
                    html += `
                        <tr>
                            <td>${controparte}</td>
                            <td>€ ${importo.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            resultDiv.innerHTML = html;
        }
        
        function generateReceipts() {
            if (results.length === 0) {
                alert('Nessun match trovato per generare ricevute');
                return;
            }
            
            const container = document.getElementById('receiptsContainer');
            const previewContainer = document.getElementById('previewArea');
            
            container.innerHTML = '';
            previewContainer.innerHTML = '<h4>Anteprima Ricevute Generate:</h4>';
            
            let alertiSuperamento = [];
            let totalePrestazioni = 0;
            let totaleRimborsi = 0;
            
            results.forEach((person, index) => {
                // Controllo limite €2.500
                const compensoNetto = person.compenso * 0.8;
                const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                const risultatoControllo = checkAndUpdateAnnualAmount(cfKey, compensoNetto);
                
                // Accumula i totali
                totalePrestazioni += person.compenso;
                totaleRimborsi += person.rimborsoSpese;
                
                if (risultatoControllo.superaLimite) {
                    alertiSuperamento.push({
                        nome: person.nome,
                        cognome: person.cognome,
                        cf: person.codiceFiscale,
                        totalePrec: risultatoControllo.totaleAttuale,
                        nuovoTotale: risultatoControllo.nuovoTotale,
                        compensoRicevuta: compensoNetto
                    });
                }
                
                const receipt = generateReceipt(person);
                container.innerHTML += receipt;
                
                // Anteprima
                const numeroRicevuta = getCurrentReceiptNumber(cfKey);
                const previewItem = document.createElement('div');
                previewItem.style.cssText = 'border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9;';
                
                let warningHtml = '';
                if (risultatoControllo.superaLimite) {
                    warningHtml = '<br><span style="color: red; font-weight: bold;">⚠️ ATTENZIONE: Supera limite €2500!</span>';
                }
                
                const mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                
                previewItem.innerHTML = `
                    <strong>#${numeroRicevuta} - ${person.nome} ${person.cognome}</strong><br>
                    CF: ${person.codiceFiscale}<br>
                    Periodo: ${mesi[person.mese]} ${person.anno}<br>
                    ${person.movimenti.length > 1 ? `Somma di ${person.movimenti.length} movimenti<br>` : ''}
                    Totale movimenti: € ${person.movimentoBancario.toFixed(2)}<br>
                    ${person.rimborsoSpese > 0 ? `Rimborso spese: € ${person.rimborsoSpese.toFixed(2)}<br>` : 'Nessun rimborso spese<br>'}
                    Compenso lordo: € ${person.compenso.toFixed(2)}<br>
                    <strong>Netto a pagare: € ${(person.compenso * 0.8 + person.rimborsoSpese).toFixed(2)}</strong><br>
                    Totale annuale: € ${risultatoControllo.nuovoTotale.toFixed(2)}${warningHtml}
                `;
                previewContainer.appendChild(previewItem);
            });
            
            // Aggiungi riepilogo totali alla fine dell'anteprima
            const totalsItem = document.createElement('div');
            totalsItem.style.cssText = 'border: 2px solid #007bff; padding: 15px; margin: 20px 0; background: #e7f3ff; font-weight: bold;';
            totalsItem.innerHTML = `
                <h4 style="color: #007bff; margin-top: 0;">RIEPILOGO TOTALI</h4>
                <div>Numero ricevute generate: <strong>${results.length}</strong></div>
                <div>Totale prestazioni (lordo): <strong>€ ${totalePrestazioni.toFixed(2)}</strong></div>
                <div>Totale rimborsi spese: <strong>€ ${totaleRimborsi.toFixed(2)}</strong></div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #007bff;">
                    <strong>TOTALE COMPLESSIVO: € ${(totalePrestazioni * 0.8 + totaleRimborsi).toFixed(2)}</strong>
                </div>
            `;
            previewContainer.appendChild(totalsItem);
            
            // Mostra alert superamento
            if (alertiSuperamento.length > 0) {
                let messaggioAlert = '⚠️ ATTENZIONE - SUPERAMENTO LIMITE €2500 NETTI ANNUALI!\n\n';
                messaggioAlert += 'I seguenti artisti superano il limite con questa ricevuta:\n\n';
                
                alertiSuperamento.forEach(alert => {
                    messaggioAlert += `${alert.nome} ${alert.cognome} (CF: ${alert.cf})\n`;
                    messaggioAlert += `- Totale precedente: € ${alert.totalePrec.toFixed(2)}\n`;
                    messaggioAlert += `- Compenso questa ricevuta: € ${alert.compensoRicevuta.toFixed(2)}\n`;
                    messaggioAlert += `- NUOVO TOTALE: € ${alert.nuovoTotale.toFixed(2)}\n\n`;
                });
                
                messaggioAlert += 'Questi artisti potrebbero dover aprire Partita IVA!';
                alert(messaggioAlert);
            }
            
            // Abilita download
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('pdfPreviewBtn').disabled = false;
            
            // Mostra tab anteprima - correzione
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Attiva specificamente il tab anteprima
            const tabs = document.querySelectorAll('.tab');
            const previewTab = tabs[1]; // Il secondo tab è l'anteprima
            previewTab.classList.add('active');
            document.getElementById('previewTab').classList.add('active');
            
            // Scorri verso l'anteprima
            document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateReceipt(person) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            const ritenuta = person.compenso * 0.20;
            const compensoNetto = person.compenso - ritenuta;
            const nettoPagare = compensoNetto + person.rimborsoSpese;
            const needsStamp = person.compenso > 77.47;
            
            // Ottieni numero progressivo
            const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
            const numeroRicevuta = getNextReceiptNumber(cfKey);
            
            const mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                         'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            // Formato con o senza rimborso spese
            if (person.rimborsoSpese === 0) {
                return `
                    <div class="ricevuta">
                        <div class="ricevuta-header">
                            <div style="text-align: left; margin-bottom: 30px;">
                                <strong>${person.nome} ${person.cognome}</strong><br>
                                ${person.indirizzo}<br>
                                ${person.cap} – ${person.citta} – ${person.provincia}<br>
                                ${person.codiceFiscale}
                            </div>
                        </div>
                        
                        <hr style="border: 1px solid #000; margin: 30px 0;">
                        
                        <div class="ricevuta-info">
                            <div>
                                <strong>SPETT.LE</strong><br>
                                OKL SRL<br>
                                VIA MONTE PASUBIO<br>
                                36010 – ZANE' – (VI)<br>
                                P.I. 04433920248
                            </div>
                            <div style="text-align: right;">
                                <strong>RICEVUTA NUM: ${numeroRicevuta}</strong><br>
                                <strong>DATA: ${dateStr}</strong>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <strong>DESCRIZIONE ATTIVITÀ:</strong> COMPENSO PER PRESTAZIONE ARTISTICA DELLO SPETTACOLO
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background-color: #003d7a;">
                                    <th style="color: white; padding: 10px; text-align: left; border: 1px solid #000;">DESCRIZIONE COMPENSO</th>
                                    <th style="color: white; padding: 10px; text-align: center; border: 1px solid #000;">IMPORTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 10px;">COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${person.compenso.toFixed(2)} €</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td style="border: 1px solid #000; padding: 10px; text-align: center;"><strong>COMPENSO LORDO</strong></td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;"><strong>${person.compenso.toFixed(2)} €</strong></td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 10px;">RITENUTA D'ACCONTO IRPEF 20% - Art. 25 DPR 633/72</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${ritenuta.toFixed(2)} €</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td style="border: 1px solid #000; padding: 10px; text-align: center;"><strong>NETTO A PAGARE</strong></td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;"><strong>${compensoNetto.toFixed(2)} €</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 30px; font-size: 12px; line-height: 1.6;">
                            <p><em>${needsStamp ? 'Imposta di bollo da 2,00 euro assolta sull\'originale per importi maggiori di 77,47 euro.' : ''}</em></p>
                            <p><em>Operazione esclusa da IVA ai sensi dell'art. 5 del D.P.R. 633/72.</em></p>
                            
                            <p style="margin-top: 20px;">
                                • Il sottoscritto dichiara che, nell'anno solare in corso, <strong>alla data odierna</strong>:
                            </p>
                            <p style="margin-left: 20px;">
                                non ha conseguito redditi derivanti dall'esercizio di attività di lavoro autonomo occasionale pari o eccedenti<br>
                                i 5.000 euro e <strong>si obbliga a comunicare l'eventuale superamento</strong> del limite annuo, anche successivamente<br>
                                alla data odierna.
                            </p>
                            
                            <div style="margin-top: 50px; text-align: right;">
                                <div style="border-bottom: 1px solid #000; width: 200px; margin-left: auto; margin-bottom: 5px;"></div>
                                <div style="font-family: 'Brush Script MT', cursive; color: #003d7a; font-size: 18px; font-style: italic;">
                                    ${person.nome} ${person.cognome}
                                </div>
                                <div style="font-size: 12px;">(Firma)</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="ricevuta">
                        <div class="ricevuta-header">
                            <div style="text-align: left; margin-bottom: 30px;">
                                <strong>${person.nome} ${person.cognome}</strong><br>
                                ${person.indirizzo}<br>
                                ${person.cap} – ${person.citta} – ${person.provincia}<br>
                                ${person.codiceFiscale}
                            </div>
                        </div>
                        
                        <hr style="border: 1px solid #000; margin: 30px 0;">
                        
                        <div class="ricevuta-info">
                            <div>
                                <strong>SPETT.LE</strong><br>
                                OKL SRL<br>
                                VIA MONTE PASUBIO<br>
                                36010 – ZANE' – (VI)<br>
                                P.I. 04433920248
                            </div>
                            <div style="text-align: right;">
                                <strong>RICEVUTA NUM: ${numeroRicevuta}</strong><br>
                                <strong>DATA: ${dateStr}</strong>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <strong>DESCRIZIONE ATTIVITÀ:</strong> COMPENSO PER PRESTAZIONE ARTISTICA DELLO SPETTACOLO
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background-color: #003d7a;">
                                    <th style="color: white; padding: 10px; text-align: left; border: 1px solid #000;">DESCRIZIONE COMPENSO</th>
                                    <th style="color: white; padding: 10px; text-align: center; border: 1px solid #000;">IMPORTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 10px;">COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${person.compenso.toFixed(2)} €</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td style="border: 1px solid #000; padding: 10px; text-align: center;"><strong>COMPENSO LORDO</strong></td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;"><strong>${person.compenso.toFixed(2)} €</strong></td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 10px;">RITENUTA D'ACCONTO IRPEF 20% - Art. 25 DPR 633/72</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${ritenuta.toFixed(2)} €</td>
                                </tr>
                                <tr style="background-color: #f0f0f0;">
                                    <td style="border: 1px solid #000; padding: 10px;">COMPENSO NETTO</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${compensoNetto.toFixed(2)} €</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 10px;">RIMBORSO SPESE</td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${person.rimborsoSpese.toFixed(2)} €</td>
                                </tr>
                                <tr style="background-color: #e0e0e0;">
                                    <td style="border: 1px solid #000; padding: 10px; text-align: center;"><strong>NETTO A PAGARE</strong></td>
                                    <td style="border: 1px solid #000; padding: 10px; text-align: right;"><strong>${nettoPagare.toFixed(2)} €</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 30px; font-size: 12px; line-height: 1.6;">
                            <p><em>${needsStamp ? 'Imposta di bollo da 2,00 euro assolta sull\'originale per importi maggiori di 77,47 euro.' : ''}</em></p>
                            <p><em>Operazione esclusa da IVA ai sensi dell'art. 5 del D.P.R. 633/72.</em></p>
                            
                            <p style="margin-top: 20px;">
                                • Il sottoscritto dichiara che, nell'anno solare in corso, <strong>alla data odierna</strong>:
                            </p>
                            <p style="margin-left: 20px;">
                                non ha conseguito redditi derivanti dall'esercizio di attività di lavoro autonomo occasionale pari o eccedenti<br>
                                i 5.000 euro e <strong>si obbliga a comunicare l'eventuale superamento</strong> del limite annuo, anche successivamente<br>
                                alla data odierna.
                            </p>
                            
                            <div style="margin-top: 50px; text-align: right;">
                                <div style="border-bottom: 1px solid #000; width: 200px; margin-left: auto; margin-bottom: 5px;"></div>
                                <div style="font-family: 'Brush Script MT', cursive; color: #003d7a; font-size: 18px; font-style: italic;">
                                    ${person.nome} ${person.cognome}
                                </div>
                                <div style="font-size: 12px;">(Firma)</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateProgressBar(progress) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
        }
        
        function createZipWithPDFs() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            btn.innerHTML = '⏳ Generazione ZIP in corso...';
            btn.disabled = true;
            document.getElementById('progressBar').style.display = 'block';

            try {
                const zip = new JSZip();
                const folder = zip.folder("Ricevute");
                let progress = 0;

                results.forEach((person, index) => {
                    const receiptHtml = generateReceipt(person);
                    const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                    const receiptNumber = getCurrentReceiptNumber(cfKey);
                    
                    // Genera PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Converti HTML in testo per il PDF
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = receiptHtml;
                    const text = tempDiv.textContent || tempDiv.innerText || '';
                    
                    pdf.setFontSize(10);
                    const lines = pdf.splitTextToSize(text, 180);
                    pdf.text(lines, 10, 20);

                    const fileName = `Ricevuta_${receiptNumber}_${person.cognome}_${person.nome}_${person.codiceFiscale}.pdf`;
                    folder.file(fileName, pdf.output('blob'));

                    progress = ((index + 1) / results.length) * 100;
                    updateProgressBar(progress);
                });

                // Genera e mostra link per download
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const currentDate = new Date().toISOString().split('T')[0];
                    
                    // Mostra link di download
                    const downloadArea = document.getElementById('downloadArea');
                    downloadArea.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin: 10px 0; text-align: center;">
                            <h4 style="color: #155724; margin-bottom: 10px;">✓ ZIP generato con successo!</h4>
                            <a href="${url}" download="Ricevute_${currentDate}.zip" 
                               style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                               📥 Clicca qui per scaricare il file ZIP
                            </a>
                        </div>
                    `;
                    
                    btn.innerHTML = '📥 Crea ZIP con PDF';
                    btn.disabled = false;
                    document.getElementById('progressBar').style.display = 'none';
                    
                    // Scroll al link
                    downloadArea.scrollIntoView({ behavior: 'smooth' });
                });

            } catch (error) {
                console.error('Errore nella generazione:', error);
                alert('Errore nella generazione del ZIP: ' + error.message);
                btn.innerHTML = '📥 Crea ZIP con PDF';
                btn.disabled = false;
                document.getElementById('progressBar').style.display = 'none';
            }
        }
        
        function exportToExcelByMonth() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            // Raggruppa le ricevute per mese
            const ricevutePerMese = {};
            
            results.forEach(person => {
                const chiaveMese = `${person.anno}-${person.mese.toString().padStart(2, '0')}`;
                if (!ricevutePerMese[chiaveMese]) {
                    ricevutePerMese[chiaveMese] = [];
                }
                ricevutePerMese[chiaveMese].push(person);
            });

            // Crea un file Excel per ogni mese
            Object.keys(ricevutePerMese).forEach(meseAnno => {
                const ricevuteMese = ricevutePerMese[meseAnno];
                const [anno, mese] = meseAnno.split('-');
                const mesiNomi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                                 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

                const excelData = [];
                
                // Intestazione
                excelData.push([
                    'Id Paese',
                    'Partita Iva', 
                    'Codice Fiscale',
                    'Denominazione',
                    'Cognome',
                    'Nome',
                    'Indirizzo',
                    'Num. civico',
                    'CAP',
                    'Comune',
                    'Provincia',
                    'Causale',
                    'Sezionale',
                    'Tipo Doc.',
                    'Data Doc.',
                    'Numero Doc.',
                    'Data doc. fattura origine',
                    'Num. doc. fattura origine',
                    'Descr. Articolo1',
                    'Imponibile1',
                    'Aliquota IVA1',
                    'Natura IVA1',
                    'Codice IVA1',
                    'Imposta1',
                    'Totale Imponibile',
                    'Totale Imposta',
                    'Totale Documento',
                    'Esigibilita\' IVA'
                ]);

                // Dati per questo mese
                ricevuteMese.forEach(person => {
                    const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                    const receiptNumber = getCurrentReceiptNumber(cfKey);
                    const dataDoc = new Date().toLocaleDateString('it-IT');
                    const denominazione = `${person.nome} ${person.cognome}`;
                    
                    // Separa indirizzo e numero civico
                    const indirizzoCompleto = person.indirizzo || '';
                    const indirizzoParti = indirizzoCompleto.split(' ');
                    let indirizzo = '';
                    let numCivico = '';
                    
                    if (indirizzoParti.length > 0) {
                        const ultimaParte = indirizzoParti[indirizzoParti.length - 1];
                        if (/^\d+[a-zA-Z]?$/.test(ultimaParte)) {
                            numCivico = ultimaParte;
                            indirizzo = indirizzoParti.slice(0, -1).join(' ');
                        } else {
                            indirizzo = indirizzoCompleto;
                        }
                    }

                    excelData.push([
                        'IT',
                        person.partitaIva || '',
                        person.codiceFiscale,
                        denominazione,
                        person.cognome,
                        person.nome,
                        indirizzo,
                        numCivico,
                        person.cap || '',
                        person.citta || '',
                        person.provincia || '',
                        '135',
                        '4',
                        'TD01',
                        dataDoc,
                        receiptNumber,
                        dataDoc,
                        '1',
                        'COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE',
                        person.compenso.toFixed(2),
                        '0',
                        'N2',
                        'NI',
                        '0',
                        person.compenso.toFixed(2),
                        '0',
                        person.compenso.toFixed(2),
                        'I'
                    ]);
                });

                // Crea e scarica il file Excel per questo mese
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `${mesiNomi[parseInt(mese)]} ${anno}`);
                
                const fileName = `Export_Ricevute_${mesiNomi[parseInt(mese)]}_${anno}.xlsx`;
                XLSX.writeFile(wb, fileName);
            });

            const numMesi = Object.keys(ricevutePerMese).length;
            alert(`Generati ${numMesi} file Excel (uno per ogni mese)!`);
        }
        
        function exportToExcel() {
            if (results.length === 0) {
                alert('Prima devi eseguire il matching e generare le ricevute!');
                return;
            }

            const excelData = [];
            
            // Intestazione
            excelData.push([
                'Id Paese',
                'Partita Iva', 
                'Codice Fiscale',
                'Denominazione',
                'Cognome',
                'Nome',
                'Indirizzo',
                'Num. civico',
                'CAP',
                'Comune',
                'Provincia',
                'Causale',
                'Sezionale',
                'Tipo Doc.',
                'Data Doc.',
                'Numero Doc.',
                'Data doc. fattura origine',
                'Num. doc. fattura origine',
                'Descr. Articolo1',
                'Imponibile1',
                'Aliquota IVA1',
                'Natura IVA1',
                'Codice IVA1',
                'Imposta1',
                'Totale Imponibile',
                'Totale Imposta',
                'Totale Documento',
                'Esigibilita\' IVA'
            ]);

            // Dati
            results.forEach(person => {
                const cfKey = person.codiceFiscale || `${person.nome}_${person.cognome}`;
                const receiptNumber = getCurrentReceiptNumber(cfKey);
                const dataDoc = new Date().toLocaleDateString('it-IT');
                const denominazione = `${person.nome} ${person.cognome}`;
                
                // Separa indirizzo e numero civico
                const indirizzoCompleto = person.indirizzo || '';
                const indirizzoParti = indirizzoCompleto.split(' ');
                let indirizzo = '';
                let numCivico = '';
                
                if (indirizzoParti.length > 0) {
                    const ultimaParte = indirizzoParti[indirizzoParti.length - 1];
                    if (/^\d+[a-zA-Z]?$/.test(ultimaParte)) {
                        numCivico = ultimaParte;
                        indirizzo = indirizzoParti.slice(0, -1).join(' ');
                    } else {
                        indirizzo = indirizzoCompleto;
                    }
                }

                excelData.push([
                    'IT',
                    person.partitaIva || '',
                    person.codiceFiscale,
                    denominazione,
                    person.cognome,
                    person.nome,
                    indirizzo,
                    numCivico,
                    person.cap || '',
                    person.citta || '',
                    person.provincia || '',
                    '135',
                    '4',
                    'TD01',
                    dataDoc,
                    receiptNumber,
                    dataDoc,
                    '1',
                    'COMPENSO PER PRESTAZIONE DI LAVORO AUTONOMO OCCASIONALE',
                    person.compenso.toFixed(2),
                    '0',
                    'N2',
                    'NI',
                    '0',
                    person.compenso.toFixed(2),
                    '0',
                    person.compenso.toFixed(2),
                    'I'
                ]);
            });

            // Crea e scarica il file Excel
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Export Ricevute");
            
            const currentDate = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Export_Ricevute_${currentDate}.xlsx`);
        }
    </script>
</body>
</html>
